name: Build IBAMR + Sanitizers + Tests + Docs

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      PETSC_VERSION: 3.17.5
      PETSC_DIR: /home/runner/petsc
      PETSC_ARCH: arch-linux-c-opt

    steps:
    # ---------------------------------------------------------
    # Checkout
    # ---------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------------------------------------------------
    # System deps
    # ---------------------------------------------------------
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc g++ gfortran make cmake ninja-build \
          libopenmpi-dev openmpi-bin \
          libhdf5-dev libboost-all-dev \
          python3 python3-dev python3-distutils \
          valgrind doxygen graphviz

    # ---------------------------------------------------------
    # Cache PETSc archive + build folder
    # ---------------------------------------------------------
    - name: Cache PETSc source
      id: cache-petsc-src
      uses: actions/cache@v4
      with:
        path: /home/runner/petsc-src
        key: petsc-src-${{ env.PETSC_VERSION }}

    - name: Cache PETSc build
      id: cache-petsc
      uses: actions/cache@v4
      with:
        path: /home/runner/petsc
        key: petsc-build-${{ env.PETSC_VERSION }}

    # ---------------------------------------------------------
    # Download PETSc if missing
    # ---------------------------------------------------------
    - name: Download PETSc (if needed)
      if: steps.cache-petsc-src.outputs.cache-hit != 'true'
      run: |
        cd /home/runner
        wget https://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-${PETSC_VERSION}.tar.gz
        tar -xzf petsc-${PETSC_VERSION}.tar.gz
        mv petsc-${PETSC_VERSION} petsc-src

    # ---------------------------------------------------------
    # Build PETSc if cache not hit
    # ---------------------------------------------------------
    - name: Build PETSc from source
      if: steps.cache-petsc.outputs.cache-hit != 'true'
      run: |
        cd /home/runner/petsc-src
        ./configure \
          --prefix=/home/runner/petsc \
          --with-debugging=0 \
          --with-shared-libraries=1 \
          --download-hypre \
          --download-metis \
          --download-parmetis \
          --download-superlu \
          --download-superlu_dist \
          --download-fblaslapack \
          --with-mpi-dir=/usr/lib/x86_64-linux-gnu/openmpi

        make all -j4
        make install

    # ---------------------------------------------------------
    # Verify PETSc
    # ---------------------------------------------------------
    - name: Verify PETSc build
      run: |
        echo "PETSC_DIR=$PETSC_DIR"
        ls -lah $PETSC_DIR
        test -f $PETSC_DIR/lib/libpetsc.so

    # ---------------------------------------------------------
    # Cache IBAMR build
    # ---------------------------------------------------------
    - name: Cache IBAMR Build
      id: cache-ibamr
      uses: actions/cache@v4
      with:
        path: IBAMR-0.18.0/build
        key: ibamr-${{ hashFiles('IBAMR-0.18.0/**') }}

    # ---------------------------------------------------------
    # Build IBAMR
    # ---------------------------------------------------------
    - name: Build IBAMR
      if: steps.cache-ibamr.outputs.cache-hit != 'true'
      run: |
        cd IBAMR-0.18.0
        mkdir -p build && cd build

        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DPETSC_DIR=${PETSC_DIR} \
          -DPETSC_ARCH=${PETSC_ARCH} \
          -DUSE_MPI=ON

        make -j$(nproc)

    # ---------------------------------------------------------
    # Build 3 Test Suites
    # ---------------------------------------------------------
    - name: Build IBAMR_Validation_Framework
      run: |
        cd IBAMR_Validation_Framework
        mkdir -p build && cd build
        cmake .. \
          -DIBAMR_DIR=${GITHUB_WORKSPACE}/IBAMR-0.18.0/build \
          -DPETSC_DIR=${PETSC_DIR} \
          -DPETSC_ARCH=${PETSC_ARCH}
        make -j$(nproc)

    - name: Build IBAMR-understand-ibamr-code
      run: |
        cd IBAMR-understand-ibamr-code
        mkdir -p build && cd build
        cmake .. \
          -DIBAMR_DIR=${GITHUB_WORKSPACE}/IBAMR-0.18.0/build \
          -DPETSC_DIR=${PETSC_DIR} \
          -DPETSC_ARCH=${PETSC_ARCH}
        make -j$(nproc)

    - name: Build ScalarTransport_TestSuite_Standalone
      run: |
        cd ScalarTransport_TestSuite_Standalone
        mkdir -p build && cd build
        cmake .. \
          -DIBAMR_DIR=${GITHUB_WORKSPACE}/IBAMR-0.18.0/build \
          -DPETSC_DIR=${PETSC_DIR} \
          -DPETSC_ARCH=${PETSC_ARCH}
        make -j$(nproc)

    # ---------------------------------------------------------
    # Run basic MPI tests
    # ---------------------------------------------------------
    - name: Run MPI smoke tests
      run: |
        mpirun -np 2 echo "MPI OK"

    # ---------------------------------------------------------
    # Build Doxygen documentation
    # ---------------------------------------------------------
    - name: Build documentation
      run: |
        doxygen -g config.doxy
        doxygen config.doxy || true
      continue-on-error: true

    # ---------------------------------------------------------
    # Optional: valgrind non-fatal check
    # ---------------------------------------------------------
    - name: Run valgrind (non-fatal)
      run: |
        valgrind --version
      continue-on-error: true

    # ---------------------------------------------------------
    # Upload artifacts
    # ---------------------------------------------------------
    - name: Upload binaries
      uses: actions/upload-artifact@v4
      with:
        name: ibamr-binaries
        path: |
          IBAMR-0.18.0/build/**
          IBAMR_Validation_Framework/build/**
          IBAMR-understand-ibamr-code/build/**
          ScalarTransport_TestSuite_Standalone/build/**
