name: Build IBAMR + Sanitizers + Tests + Docs

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      PETSC_VERSION: 3.17.5
      PETSC_DIR: $HOME/petsc
      PETSC_ARCH: arch-linux-c-opt

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    # ============================================================
    # INSTALL SYSTEM DEPENDENCIES
    # ============================================================
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc g++ gfortran make cmake ninja-build \
          python3 python3-dev python3-distutils \
          libopenmpi-dev openmpi-bin \
          libhdf5-dev libboost-all-dev \
          libeigen3-dev liblapack-dev libblas-dev \
          doxygen graphviz \
          clang clang-tidy valgrind cppcheck

    # ============================================================
    # PETSC CACHING (source tarball + compiled build)
    # ============================================================
    - name: Cache PETSc source
      id: cache-petsc-src
      uses: actions/cache@v4
      with:
        path: $HOME/petsc-${{ env.PETSC_VERSION }}.tar.gz
        key: ${{ runner.os }}-petsc-src-${{ env.PETSC_VERSION }}

    - name: Cache PETSc build
      id: cache-petsc-build
      uses: actions/cache@v4
      with:
        path: $HOME/petsc
        key: ${{ runner.os }}-petsc-build-${{ env.PETSC_VERSION }}

    # ============================================================
    # DOWNLOAD PETSC (IF NECESSARY)
    # ============================================================
    - name: Download PETSc (if not cached)
      if: steps.cache-petsc-src.outputs.cache-hit != 'true'
      run: |
        cd $HOME
        wget -O petsc-${PETSC_VERSION}.tar.gz \
          https://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-${PETSC_VERSION}.tar.gz

    # ============================================================
    # BUILD PETSC (IF NOT CACHED)
    # ============================================================
    - name: Build PETSc from source
      if: steps.cache-petsc-build.outputs.cache-hit != 'true'
      run: |
        cd $HOME
        tar -xzf petsc-${PETSC_VERSION}.tar.gz
        mv petsc-${PETSC_VERSION} petsc
        cd petsc

        ./configure \
          --with-debugging=0 \
          --with-shared-libraries=1 \
          --download-fblaslapack \
          --download-hypre \
          --download-metis \
          --download-parmetis \
          --download-superlu \
          --download-superlu_dist

        make PETSC_DIR=$HOME/petsc PETSC_ARCH=$PETSC_ARCH all -j$(nproc)
        make PETSC_DIR=$HOME/petsc PETSC_ARCH=$PETSC_ARCH test

    # ============================================================
    # VERIFY PETSC
    # ============================================================
    - name: Verify PETSc build
      run: |
        echo "PETSC_DIR=$PETSC_DIR"
        ls -lah $PETSC_DIR

    # ============================================================
    # CACHE IBAMR
    # ============================================================
    - name: Cache IBAMR Build
      id: cache-ibamr
      uses: actions/cache@v4
      with:
        path: IBAMR-0.18.0/build
        key: ${{ runner.os }}-ibamr-${{ hashFiles('IBAMR-0.18.0/**') }}

    # ============================================================
    # BUILD IBAMR
    # ============================================================
    - name: Build IBAMR
      if: steps.cache-ibamr.outputs.cache-hit != 'true'
      run: |
        cd IBAMR-0.18.0
        mkdir -p build
        cd build

        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DPETSC_DIR=$PETSC_DIR \
          -DPETSC_ARCH=$PETSC_ARCH

        make -j$(nproc)

    # ============================================================
    # COMPILE ALL TEST SUITES
    # ============================================================
    - name: Build Validation Framework
      run: |
        cd IBAMR_Validation_Framework
        mkdir -p build
        cd build
        cmake .. -DIBAMR_DIR=${GITHUB_WORKSPACE}/IBAMR-0.18.0/build \
                 -DPETSC_DIR=$PETSC_DIR \
                 -DPETSC_ARCH=$PETSC_ARCH
        make -j$(nproc)

    - name: Build Understand IBAMR Code
      run: |
        cd IBAMR-understand-ibamr-code
        mkdir -p build
        cd build
        cmake .. -DIBAMR_DIR=${GITHUB_WORKSPACE}/IBAMR-0.18.0/build \
                 -DPETSC_DIR=$PETSC_DIR \
                 -DPETSC_ARCH=$PETSC_ARCH
        make -j$(nproc)

    - name: Build ScalarTransport Suite
      run: |
        cd ScalarTransport_TestSuite_Standalone
        mkdir -p build
        cd build
        cmake .. -DIBAMR_DIR=${GITHUB_WORKSPACE}/IBAMR-0.18.0/build \
                 -DPETSC_DIR=$PETSC_DIR \
                 -DPETSC_ARCH=$PETSC_ARCH
        make -j$(nproc)

    # ============================================================
    # RUN MPI TESTS
    # ============================================================
    - name: Run MPI Smoke Tests
      run: |
        cd IBAMR_Validation_Framework/build
        mpirun -np 2 ./example_validation_binary || true

    # ============================================================
    # SANITIZERS (ASAN + LSAN)
    # ============================================================
    - name: Run Sanitizer Build
      run: |
        cd IBAMR-understand-ibamr-code
        mkdir -p san_build
        cd san_build
        CC=clang CXX=clang++ \
        cmake .. \
          -DCMAKE_CXX_FLAGS="-fsanitize=address,leak -g" \
          -DCMAKE_BUILD_TYPE=Debug \
          -DIBAMR_DIR=${GITHUB_WORKSPACE}/IBAMR-0.18.0/build \
          -DPETSC_DIR=$PETSC_DIR \
          -DPETSC_ARCH=$PETSC_ARCH
        make -j$(nproc)

    # ============================================================
    # VALGRIND MEMORY CHECKS
    # ============================================================
    - name: Run Valgrind Check
      run: |
        cd ScalarTransport_TestSuite_Standalone/build
        valgrind --error-exitcode=1 ./transport_solver_example || true

    # ============================================================
    # CODE STYLE LINTING
    # ============================================================
    - name: Run Clang-Tidy
      run: |
        clang-tidy IBAMR-understand-ibamr-code/**/*.cpp -- -std=c++17 || true

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --suppress=missingIncludeSystem . || true

    # ============================================================
    # BUILD DOXYGEN DOCS
    # ============================================================
    - name: Build Doxygen Documentation
      run: |
        doxygen Doxyfile || true

    - name: Upload Docs
      uses: actions/upload-artifact@v4
      with:
        name: ibamr-docs
        path: docs/

    # ============================================================
    # UPLOAD ARTIFACTS
    # ============================================================
    - name: Upload built binaries
      uses: actions/upload-artifact@v4
      with:
        name: ibamr-binaries
        path: |
          IBAMR-0.18.0/build/**
          IBAMR_Validation_Framework/build/**
          IBAMR-understand-ibamr-code/build/**
          ScalarTransport_TestSuite_Standalone/build/**
