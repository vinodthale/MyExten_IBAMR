name: Build IBAMR + SAMRAI2 DIM=2 and DIM=3 (working)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      PETSC_DIR: /home/runner/petsc
      PETSC_ARCH: arch-linux-c-opt
      SAMRAI2_DIM2: /home/runner/samrai2-dim2
      SAMRAI2_DIM3: /home/runner/samrai2-dim3

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system deps
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential gfortran gcc g++ make cmake ninja-build \
          python3 python3-pip python3-dev python3-distutils \
          libopenmpi-dev openmpi-bin \
          libhdf5-dev liblapack-dev libblas-dev pkg-config \
          libboost-all-dev libeigen3-dev \
          wget curl git unzip valgrind doxygen graphviz

    # ---------------------------------------------------------
    # PETSc cache
    # ---------------------------------------------------------
    - uses: actions/cache@v4
      id: petsc-src
      with:
        path: /home/runner/petsc-src
        key: ${{ runner.os }}-petsc-src-3.17.5

    - uses: actions/cache@v4
      id: petsc-build
      with:
        path: /home/runner/petsc
        key: ${{ runner.os }}-petsc-build-3.17.5

    - name: Download PETSc if needed
      if: steps.petsc-src.outputs.cache-hit != 'true'
      run: |
        mkdir -p /home/runner/petsc-src
        cd /home/runner/petsc-src
        wget -q https://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-3.17.5.tar.gz
        tar -xzf petsc-3.17.5.tar.gz

    - name: Build PETSc
      if: steps.petsc-build.outputs.cache-hit != 'true'
      run: |
        set -e
        cd /home/runner
        rm -rf petsc
        cp -r petsc-src/petsc-3.17.5 petsc
        cd petsc
        export PETSC_DIR=/home/runner/petsc
        export PETSC_ARCH=arch-linux-c-opt

        ./configure \
          --with-debugging=0 \
          --with-shared-libraries=1 \
          --download-hypre \
          --download-metis \
          --download-parmetis \
          --download-superlu \
          --download-superlu_dist \
          --download-fblaslapack

        make all -j$(nproc)

    - name: Verify PETSc
      run: ls -la $PETSC_DIR/$PETSC_ARCH

    # ---------------------------------------------------------
    # Clone IBSAMRAI2 fork
    # ---------------------------------------------------------
    - uses: actions/cache@v4
      id: samrai-src
      with:
        path: /home/runner/IBSAMRAI2-src
        key: ${{ runner.os }}-ibsamrai2-src-2025-02-20

    - name: Clone IBSAMRAI2 if needed
      if: steps.samrai-src.outputs.cache-hit != 'true'
      run: |
        rm -rf /home/runner/IBSAMRAI2-src
        git clone --depth=1 https://github.com/IBAMR/IBSAMRAI2.git /home/runner/IBSAMRAI2-src

    # ---------------------------------------------------------
    # Build DIM=2 in its own build directory
    # ---------------------------------------------------------
    - name: Build SAMRAI2 DIM=2
      run: |
        set -e
        cd /home/runner/IBSAMRAI2-src
        rm -rf build-2d
        mkdir build-2d && cd build-2d

        HDF5_INC=$(pkg-config --variable=includedir hdf5)
        HDF5_LIB=$(pkg-config --variable=libdir hdf5)

        ../configure \
          --prefix=$SAMRAI2_DIM2 \
          --enable-opt \
          --disable-debug \
          --with-CC=mpicc \
          --with-CXX=mpicxx \
          --with-F77=mpif77 \
          --with-hdf5=$HDF5_LIB \
          CPPFLAGS="-I$HDF5_INC" \
          LDFLAGS="-L$HDF5_LIB -lhdf5"

        make -j$(nproc)
        make install

    # ---------------------------------------------------------
    # Build DIM=3 in its own build directory
    # ---------------------------------------------------------
    - name: Build SAMRAI2 DIM=3
      run: |
        set -e
        cd /home/runner/IBSAMRAI2-src
        rm -rf build-3d
        mkdir build-3d && cd build-3d

        HDF5_INC=$(pkg-config --variable=includedir hdf5)
        HDF5_LIB=$(pkg-config --variable=libdir hdf5)

        ../configure \
          --prefix=$SAMRAI2_DIM3 \
          --enable-opt \
          --disable-debug \
          --with-CC=mpicc \
          --with-CXX=mpicxx \
          --with-F77=mpif77 \
          --with-hdf5=$HDF5_LIB \
          CPPFLAGS="-I$HDF5_INC" \
          LDFLAGS="-L$HDF5_LIB -lhdf5"

        make -j$(nproc)
        make install

    # ---------------------------------------------------------
    # Build IBAMR using DIM=2 SAMRAI (standard)
    # ---------------------------------------------------------
    - name: Build IBAMR
      run: |
        cd IBAMR-0.18.0
        rm -rf build
        mkdir build && cd build

        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DPETSC_DIR=$PETSC_DIR \
          -DPETSC_ARCH=$PETSC_ARCH \
          -DSAMRAI_ROOT=$SAMRAI2_DIM2

        make -j$(nproc)

    # ---------------------------------------------------------
    # Upload artifacts
    # ---------------------------------------------------------
    - uses: actions/upload-artifact@v4
      with:
        name: ibamr-binaries
        path: IBAMR-0.18.0/build/**
