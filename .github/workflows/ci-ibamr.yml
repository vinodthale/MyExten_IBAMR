name: Build IBAMR + Tests + Sanitizers + Docs

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      # absolute PETSc path used throughout
      PETSC_DIR: /home/runner/petsc
      PETSC_ARCH: arch-linux-c-opt
      # (these are set after PETSc build; used to configure IBAMR)
      HYPRE_INC: /home/runner/petsc/arch-linux-c-opt/include
      HYPRE_LIB: /home/runner/petsc/arch-linux-c-opt/lib/libHYPRE.so
      SAMRAI2_INSTALL: /home/runner/IBSAMRAI2-install

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential gcc g++ gfortran make cmake ninja-build \
          python3 python3-pip python3-dev python3-distutils \
          libopenmpi-dev openmpi-bin \
          libhdf5-dev liblapack-dev libblas-dev \
          libboost-all-dev libeigen3-dev \
          wget curl git ca-certificates unzip \
          valgrind doxygen graphviz pkg-config

    # -----------------------------
    # PETSc: cache source + build
    # -----------------------------
    - name: Cache PETSc source
      id: cache-petsc-src
      uses: actions/cache@v4
      with:
        path: /home/runner/petsc-src
        key: ${{ runner.os }}-petsc-src-3.17.5

    - name: Cache PETSc build
      id: cache-petsc-build
      uses: actions/cache@v4
      with:
        path: /home/runner/petsc
        key: ${{ runner.os }}-petsc-build-3.17.5

    - name: Download PETSc (if needed)
      if: steps.cache-petsc-src.outputs.cache-hit != 'true'
      run: |
        mkdir -p /home/runner/petsc-src
        cd /home/runner/petsc-src
        wget -q https://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-3.17.5.tar.gz
        tar -xzf petsc-3.17.5.tar.gz

    - name: Build PETSc from source (if needed)
      if: steps.cache-petsc-build.outputs.cache-hit != 'true'
      run: |
        set -euo pipefail
        cd /home/runner
        rm -rf petsc || true
        cp -r /home/runner/petsc-src/petsc-3.17.5 petsc
        cd petsc

        # Use absolute PETSC_DIR and PETSC_ARCH
        export PETSC_DIR=/home/runner/petsc
        export PETSC_ARCH=arch-linux-c-opt

        ./configure \
          --with-debugging=0 \
          --with-shared-libraries=1 \
          --download-hypre \
          --download-metis \
          --download-parmetis \
          --download-superlu \
          --download-superlu_dist \
          --download-fblaslapack

        # build/test - parallel make to speed up
        make all -j$(nproc)
        # run a light set of tests (can be heavy; optional)
        make test

    - name: Verify PETSc
      run: |
        echo "PETSC_DIR=$PETSC_DIR"
        echo "PETSC_ARCH=$PETSC_ARCH"
        ls -la $PETSC_DIR || true
        ls -la $PETSC_DIR/$PETSC_ARCH || true
        echo "HYPRE headers (example):"
        ls -la $HYPRE_INC || true

    # -----------------------------
    # Cache IBAMR build (to speed re-runs)
    # -----------------------------
    - name: Cache IBAMR build
      id: cache-ibamr
      uses: actions/cache@v4
      with:
        path: IBAMR-0.18.0/build
        key: ${{ runner.os }}-ibamr-${{ hashFiles('IBAMR-0.18.0/**') }}

    # -----------------------------
    # Build SAMRAI (IBAMR's IBSAMRAI2 fork)
    # -----------------------------
    # IBAMR expects its SAMRAI fork (IBSAMRAI2). The IBAMR org provides this.
    - name: Cache IBSAMRAI2 source
      id: cache-samrai-src
      uses: actions/cache@v4
      with:
        path: /home/runner/IBSAMRAI2-src
        key: ${{ runner.os }}-ibsamrai2-src-v2025-10-29

    - name: Clone IBSAMRAI2 (if needed)
      if: steps.cache-samrai-src.outputs.cache-hit != 'true'
      run: |
        rm -rf /home/runner/IBSAMRAI2-src
        mkdir -p /home/runner/IBSAMRAI2-src
        cd /home/runner/IBSAMRAI2-src
        # clone the official IBAMR IBSAMRAI2 fork (latest from default branch)
        git clone --depth 1 https://github.com/IBAMR/IBSAMRAI2.git .

    - name: Build IBSAMRAI2 (SAMRAI2) and install
      run: |
        set -euo pipefail
        cd /home/runner/IBSAMRAI2-src

        # IBSAMRAI2 uses autotools, not CMake
        ./configure \
          --prefix=$SAMRAI2_INSTALL \
          --enable-opt \
          --disable-debug \
          --with-CXX=mpicxx \
          --with-CC=mpicc \
          --with-F77=mpif77 \
          --with-hdf5=/usr

        make -j$(nproc)
        make install

    - name: Verify SAMRAI2 install
      run: |
        echo "SAMRAI2 installed to $SAMRAI2_INSTALL"
        ls -la $SAMRAI2_INSTALL || true
        # ensure IBAMR will find SAMRAI2 headers
        ls -la $SAMRAI2_INSTALL/include || true

    # -----------------------------
    # Build IBAMR
    # -----------------------------
    - name: Build IBAMR
      if: steps.cache-ibamr.outputs.cache-hit != 'true'
      run: |
        set -euo pipefail
        cd IBAMR-0.18.0
        mkdir -p build
        cd build

        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DPETSC_DIR=$PETSC_DIR \
          -DPETSC_ARCH=$PETSC_ARCH \
          -DHYPRE_INCLUDE_DIR=$HYPRE_INC \
          -DHYPRE_LIBRARY=$HYPRE_LIB \
          -DSAMRAI_ROOT=$SAMRAI2_INSTALL

        make -j$(nproc)

    # -----------------------------
    # Python deps for the validation framework
    # -----------------------------
    - name: Setup Python deps (Validation Framework)
      run: |
        python3 -m pip install --upgrade pip
        pip3 install numpy matplotlib scipy

    # -----------------------------
    # Build the three test suites you listed
    # -----------------------------
    - name: Build IBAMR_Validation_Framework
      run: |
        set -euo pipefail
        cd IBAMR_Validation_Framework
        mkdir -p build && cd build
        cmake .. \
          -DIBAMR_DIR=${{ github.workspace }}/IBAMR-0.18.0/build \
          -DPETSC_DIR=$PETSC_DIR \
          -DPETSC_ARCH=$PETSC_ARCH \
          -DSAMRAI_ROOT=$SAMRAI2_INSTALL
        make -j$(nproc)

    - name: Build IBAMR-understand-ibamr-code
      run: |
        set -euo pipefail
        cd IBAMR-understand-ibamr-code
        mkdir -p build && cd build
        cmake .. \
          -DIBAMR_DIR=${{ github.workspace }}/IBAMR-0.18.0/build \
          -DPETSC_DIR=$PETSC_DIR \
          -DPETSC_ARCH=$PETSC_ARCH \
          -DSAMRAI_ROOT=$SAMRAI2_INSTALL
        make -j$(nproc)

    - name: Build ScalarTransport_TestSuite_Standalone
      run: |
        set -euo pipefail
        cd ScalarTransport_TestSuite_Standalone
        mkdir -p build && cd build
        cmake .. \
          -DIBAMR_DIR=${{ github.workspace }}/IBAMR-0.18.0/build \
          -DPETSC_DIR=$PETSC_DIR \
          -DPETSC_ARCH=$PETSC_ARCH \
          -DSAMRAI_ROOT=$SAMRAI2_INSTALL
        make -j$(nproc)

    # -----------------------------
    # Simple MPI smoke test
    # -----------------------------
    - name: Run MPI smoke test
      run: |
        mpirun -np 2 echo "MPI ok"

    # -----------------------------
    # Optional: ASan / Valgrind steps (disabled by default)
    # -----------------------------
    - name: ASan build (disabled)
      if: false
      run: |
        echo "Enable ASan manually"

    - name: Valgrind test (disabled)
      if: false
      run: |
        echo "Enable valgrind manually"

    # -----------------------------
    # Docs (optional)
    # -----------------------------
    - name: Build Doxygen docs
      run: |
        if [ -f Doxyfile ]; then
          doxygen Doxyfile
        else
          echo "No Doxyfile - skipping"
        fi

    # -----------------------------
    # Upload artifacts
    # -----------------------------
    - name: Upload built binaries
      uses: actions/upload-artifact@v4
      with:
        name: ibamr-binaries
        path: |
          IBAMR-0.18.0/build/**
          IBAMR_Validation_Framework/build/**
          IBAMR-understand-ibamr-code/build/**
          ScalarTransport_TestSuite_Standalone/build/**
        retention-days: 7
