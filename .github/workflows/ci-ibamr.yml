name: Fast IBAMR Build + Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      PETSC_DIR: /home/runner/petsc
      PETSC_ARCH: arch-linux-opt
      SAMRAI2_SRC: /home/runner/IBSAMRAI2-src
      SAMRAI2_INSTALL: /home/runner/IBSAMRAI2-install

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system packages
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential cmake ninja-build \
          gfortran gcc g++ \
          libopenmpi-dev openmpi-bin \
          libhdf5-dev \
          liblapack-dev libblas-dev \
          git curl wget unzip \
          python3 python3-pip \
          pkg-config

    # ----------------------------------------------------
    # PETSc caching
    # ----------------------------------------------------
    - name: Cache PETSc source
      id: petsc-src-cache
      uses: actions/cache@v4
      with:
        path: /home/runner/petsc-src
        key: ${{ runner.os }}-petsc-src-3.17.5-minimal

    - name: Cache PETSc build
      id: petsc-build-cache
      uses: actions/cache@v4
      with:
        path: /home/runner/petsc
        key: ${{ runner.os }}-petsc-build-3.17.5-minimal

    - name: Download PETSc (if needed)
      if: steps.petsc-src-cache.outputs.cache-hit != 'true'
      run: |
        mkdir -p /home/runner/petsc-src
        cd /home/runner/petsc-src
        wget -q https://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-3.17.5.tar.gz
        tar -xzf petsc-3.17.5.tar.gz

    - name: Build PETSc minimal (fast)
      if: steps.petsc-build-cache.outputs.cache-hit != 'true'
      run: |
        cd /home/runner
        rm -rf petsc
        cp -r petsc-src/petsc-3.17.5 petsc
        cd petsc

        ./configure \
          --with-debugging=0 \
          --with-shared-libraries=1 \
          --download-fblaslapack \
          --download-hypre=1 \
          --with-openmp=0 \
          --with-x=0

        make all -j$(nproc)

    - name: Verify PETSc
      run: |
        echo "PETSc installed:"
        ls -lah $PETSC_DIR/$PETSC_ARCH

    # ----------------------------------------------------
    # SAMRAI2 caching + build
    # ----------------------------------------------------
    - name: Cache SAMRAI2 source
      id: samrai-src-cache
      uses: actions/cache@v4
      with:
        path: ${{ env.SAMRAI2_SRC }}
        key: ${{ runner.os }}-samrai2-src-v1

    - name: Clone SAMRAI2 fork (IBAMR)
      if: steps.samrai-src-cache.outputs.cache-hit != 'true'
      run: |
        rm -rf $SAMRAI2_SRC
        git clone --depth 1 https://github.com/IBAMR/IBSAMRAI2.git $SAMRAI2_SRC

    - name: Build SAMRAI2 (fast)
      run: |
        cd $SAMRAI2_SRC

        export HDF5_INC=/usr/include/hdf5/serial
        export HDF5_LIB=/usr/lib/x86_64-linux-gnu/hdf5/serial

        ./configure \
          --prefix=$SAMRAI2_INSTALL \
          --enable-opt \
          --disable-debug \
          --with-hdf5=$HDF5_LIB \
          CPPFLAGS="-I$HDF5_INC" \
          LDFLAGS="-L$HDF5_LIB -lhdf5"

        make -j$(nproc)
        make install

    # ----------------------------------------------------
    # Build IBAMR core library
    # ----------------------------------------------------
    - name: Build IBAMR
      run: |
        cd IBAMR-0.18.0
        mkdir -p build
        cd build

        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DPETSC_DIR=$PETSC_DIR \
          -DPETSC_ARCH=$PETSC_ARCH \
          -DHYPRE_LIBRARY=$PETSC_DIR/$PETSC_ARCH/lib/libHYPRE.so \
          -DHYPRE_INCLUDE_DIR=$PETSC_DIR/$PETSC_ARCH/include \
          -DSAMRAI_ROOT=$SAMRAI2_INSTALL

        make -j$(nproc)

    # ----------------------------------------------------
    # Build your 3 test suites
    # ----------------------------------------------------
    - name: Build IBAMR_Validation_Framework
      run: |
        cd IBAMR_Validation_Framework
        mkdir -p build && cd build
        cmake .. -DIBAMR_DIR=${{ github.workspace }}/IBAMR-0.18.0/build \
                 -DPETSC_DIR=$PETSC_DIR -DPETSC_ARCH=$PETSC_ARCH \
                 -DSAMRAI_ROOT=$SAMRAI2_INSTALL
        make -j$(nproc)

    - name: Build IBAMR-understand-ibamr-code
      run: |
        cd IBAMR-understand-ibamr-code
        mkdir -p build && cd build
        cmake .. -DIBAMR_DIR=${{ github.workspace }}/IBAMR-0.18.0/build \
                 -DPETSC_DIR=$PETSC_DIR -DPETSC_ARCH=$PETSC_ARCH \
                 -DSAMRAI_ROOT=$SAMRAI2_INSTALL
        make -j$(nproc)

    - name: Build ScalarTransport_TestSuite_Standalone
      run: |
        cd ScalarTransport_TestSuite_Standalone
        mkdir -p build && cd build
        cmake .. -DIBAMR_DIR=${{ github.workspace }}/IBAMR-0.18.0/build \
                 -DPETSC_DIR=$PETSC_DIR -DPETSC_ARCH=$PETSC_ARCH \
                 -DSAMRAI_ROOT=$SAMRAI2_INSTALL
        make -j$(nproc)

    # ----------------------------------------------------
    # Upload artifacts
    # ----------------------------------------------------
    - name: Upload built binaries
      uses: actions/upload-artifact@v4
      with:
        name: ibamr-binaries
        path: |
          IBAMR-0.18.0/build/**
          IBAMR_Validation_Framework/build/**
          IBAMR-understand-ibamr-code/build/**
          ScalarTransport_TestSuite_Standalone/build/**

