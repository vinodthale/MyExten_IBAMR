name: Build IBAMR + Tests + Sanitizers + Docs

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      PETSC_DIR: /home/runner/petsc
      PETSC_ARCH: arch-linux-c-opt
      HYPRE_ROOT: /home/runner/petsc/arch-linux-c-opt

    steps:
    # ---------------------------------------------------------
    # Checkout
    # ---------------------------------------------------------
    - uses: actions/checkout@v4

    # ---------------------------------------------------------
    # Install dependencies
    # ---------------------------------------------------------
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc g++ gfortran make cmake \
          libopenmpi-dev openmpi-bin \
          python3 python3-dev python3-pip python3-distutils \
          libhdf5-dev liblapack-dev libblas-dev \
          libboost-all-dev libeigen3-dev \
          valgrind doxygen graphviz

    # ---------------------------------------------------------
    # Cache PETSc source
    # ---------------------------------------------------------
    - name: Cache PETSc source
      id: cache-petsc-src
      uses: actions/cache@v4
      with:
        path: /home/runner/petsc-src
        key: ${{ runner.os }}-petsc-src-3.17.5

    # ---------------------------------------------------------
    # Cache PETSc build
    # ---------------------------------------------------------
    - name: Cache PETSc build
      id: cache-petsc-build
      uses: actions/cache@v4
      with:
        path: /home/runner/petsc
        key: ${{ runner.os }}-petsc-build-3.17.5

    # ---------------------------------------------------------
    # Download PETSc if needed
    # ---------------------------------------------------------
    - name: Download PETSc
      if: steps.cache-petsc-src.outputs.cache-hit != 'true'
      run: |
        mkdir -p /home/runner/petsc-src
        cd /home/runner/petsc-src
        wget https://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-3.17.5.tar.gz
        tar -xzf petsc-3.17.5.tar.gz

    # ---------------------------------------------------------
    # Build PETSc
    # ---------------------------------------------------------
    - name: Build PETSc
      if: steps.cache-petsc-build.outputs.cache-hit != 'true'
      run: |
        cd /home/runner
        rm -rf petsc
        cp -r petsc-src/petsc-3.17.5 petsc
        cd petsc

        export PETSC_DIR=/home/runner/petsc
        export PETSC_ARCH=arch-linux-c-opt

        ./configure \
          --with-debugging=0 \
          --with-shared-libraries=1 \
          --download-hypre \
          --download-metis \
          --download-parmetis \
          --download-superlu \
          --download-superlu_dist \
          --download-fblaslapack

        make all -j4
        make test

    # ---------------------------------------------------------
    # Verify PETSc and HYPRE
    # ---------------------------------------------------------
    - name: Verify PETSc and HYPRE
      run: |
        ls -lah $PETSC_DIR
        echo "Using PETSC_ARCH=$PETSC_ARCH"
        echo "HYPRE_ROOT=$HYPRE_ROOT"
        echo "Checking for HYPRE files..."
        ls -lah $HYPRE_ROOT/include/HYPRE*.h || echo "HYPRE headers not found"
        ls -lah $HYPRE_ROOT/lib/libHYPRE.* || echo "HYPRE library not found"

    # ---------------------------------------------------------
    # Cache IBAMR build
    # ---------------------------------------------------------
    - name: Cache IBAMR
      id: cache-ibamr
      uses: actions/cache@v4
      with:
        path: IBAMR-0.18.0/build
        key: ${{ runner.os }}-ibamr-${{ hashFiles('IBAMR-0.18.0/**') }}

    # ---------------------------------------------------------
    # Build IBAMR
    # ---------------------------------------------------------
    - name: Build IBAMR
      if: steps.cache-ibamr.outputs.cache-hit != 'true'
      run: |
        cd IBAMR-0.18.0
        mkdir -p build
        cd build

        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DPETSC_DIR=$PETSC_DIR \
          -DPETSC_ARCH=$PETSC_ARCH \
          -DHYPRE_ROOT=$HYPRE_ROOT

        make -j$(nproc)

    # ---------------------------------------------------------
    # Install Python deps for Validation Framework
    # ---------------------------------------------------------
    - name: Setup Python deps (Validation Framework)
      run: pip install numpy matplotlib scipy

    # ---------------------------------------------------------
    # Build Validation Framework simulations
    # ---------------------------------------------------------
    - name: Build IBAMR_Validation_Framework
      run: |
        cd IBAMR_Validation_Framework
        mkdir -p build
        cd build
        cmake .. \
          -DIBAMR_DIR=${GITHUB_WORKSPACE}/IBAMR-0.18.0/build \
          -DPETSC_DIR=$PETSC_DIR \
          -DPETSC_ARCH=$PETSC_ARCH
        make -j$(nproc)

    # ---------------------------------------------------------
    # Build Understand-IBAMR Examples
    # ---------------------------------------------------------
    - name: Build IBAMR-understand-ibamr-code
      run: |
        cd IBAMR-understand-ibamr-code
        mkdir -p build
        cd build
        cmake .. \
          -DIBAMR_DIR=${GITHUB_WORKSPACE}/IBAMR-0.18.0/build \
          -DPETSC_DIR=$PETSC_DIR \
          -DPETSC_ARCH=$PETSC_ARCH
        make -j$(nproc)

    # ---------------------------------------------------------
    # Build Scalar Transport Suite
    # ---------------------------------------------------------
    - name: Build ScalarTransport_TestSuite_Standalone
      run: |
        cd ScalarTransport_TestSuite_Standalone
        mkdir -p build
        cd build
        cmake .. \
          -DIBAMR_DIR=${GITHUB_WORKSPACE}/IBAMR-0.18.0/build \
          -DPETSC_DIR=$PETSC_DIR \
          -DPETSC_ARCH=$PETSC_ARCH
        make -j$(nproc)

    # ---------------------------------------------------------
    # Run simple MPI test
    # ---------------------------------------------------------
    - name: Run MPI smoke test
      run: |
        mpirun -np 2 echo "MPI ok"

    # ---------------------------------------------------------
    # Run AddressSanitizer build (optional)
    # ---------------------------------------------------------
    - name: ASan Build (optional)
      if: false   # enable later by setting true
      run: |
        echo "Building with AddressSanitizer..."
        cd IBAMR-0.18.0
        mkdir -p asan
        cd asan
        cmake .. \
          -DCMAKE_C_FLAGS="-fsanitize=address" \
          -DCMAKE_CXX_FLAGS="-fsanitize=address" \
          -DPETSC_DIR=$PETSC_DIR \
          -DPETSC_ARCH=$PETSC_ARCH \
          -DHYPRE_ROOT=$HYPRE_ROOT
        make -j$(nproc)

    # ---------------------------------------------------------
    # Valgrind memory test (optional)
    # ---------------------------------------------------------
    - name: Run Valgrind Test (optional)
      if: false
      run: |
        valgrind --leak-check=full echo "Valgrind OK"

    # ---------------------------------------------------------
    # Build Doxygen Docs
    # ---------------------------------------------------------
    - name: Build Doxygen Docs
      run: |
        if [ -f Doxyfile ]; then
          doxygen Doxyfile
        else
          echo "No Doxyfile found, skipping docs"
        fi

    # ---------------------------------------------------------
    # Upload binaries
    # ---------------------------------------------------------
    - name: Upload binaries
      uses: actions/upload-artifact@v4
      with:
        name: ibamr-binaries
        path: |
          IBAMR-0.18.0/build/**
          IBAMR_Validation_Framework/build/**
          IBAMR-understand-ibamr-code/build/**
          ScalarTransport_TestSuite_Standalone/build/**
        retention-days: 7
